# 威科夫选股系统重构需求说明（详细版）

## 1. 文档目的

本说明用于指导“威科夫选股系统”从现有项目中独立重构，形成一套以威科夫量价分析为核心、可解释、可回测、可复盘、可持续迭代的选股与交易研究平台。

本文档整合了我们前期讨论的关键结论、出现过的典型问题、业务目标、实现路径和验收标准，目标是让开发与使用两端都能据此直接执行。

---

## 2. 前期讨论关键结论汇总（必须纳入新项目）

1. 核心方向从“趋势优先”转为“威科夫优先”，趋势策略降级为可选预筛工具。
2. 威科夫策略应支持独立运行，不应被强制绑定到原趋势筛选流程。
3. 新策略需要显式支持阶段识别，而不仅是单一事件命中。
4. 必须支持关键事件识别：PS、SC、AR、ST、TSO、Spring、SOS、JOC、LPS。
5. 需要补充派发侧事件：UTAD、SOW、LPSY。
6. 结构识别必须包含 HH/HL/HC（更高高点/更高低点/更高收盘）。
7. 需要在图表中体现“阶段 + 事件 + 结构”的联合解释能力。
8. 用户希望可先构建股票池再做威科夫筛选，也可直接全市场威科夫扫描。
9. 回测模块必须与筛选模块解耦，避免“互相影响结果”的误导。
10. 回测必须支持胜率、回撤、收益、交易明细、参数快照导出。
11. 回测记录必须符合A股交易常识，默认执行T+1，不应出现T+0卖出。
12. 需要解释并展示“组合约束跳过信号”的原因和数量。
13. 多信号同日冲突时必须“优中选优”，不能只按先来后到。
14. 优中选优需要可配置策略模式，而不是固定单一打分。
15. UI文本应中英混合、术语清晰，避免标签歧义与误导。
16. 8步标准序列应完整呈现，并附中文解释。
17. 应支持点数图（Point & Figure）作为威科夫分析增强视图。
18. TDX分钟数据（1m/5m）是后续扩展方向，日线仍是基础主链路。

---

## 3. 重构目标与产品定位

## 3.1 总目标

构建一个“威科夫结构分析驱动”的选股与回测系统，支持：

- 阶段扫描（全市场/指定池）
- 事件筛选（吸筹与派发双侧）
- 结构评分（HH/HL/HC与阶段协同）
- 策略回测（可配置仓位、约束、交易成本、T+1）
- 报告导出（交易+指标+参数+配置快照）

## 3.2 非目标（第一阶段不强求）

- 全自动实盘交易执行
- 高频撮合级别精确回放
- 复杂期权/融资融券建模
- 多市场统一撮合引擎

---

## 4. 注意事项（策略、数据、回测、UI）

## 4.1 策略注意事项

- 威科夫事件是“概率型证据”，不是“确定性买卖点”。
- 单事件命中不可直接交易，建议结合阶段、结构、量能、风险约束。
- 阶段判断需容忍噪声，不能依赖单根K线极值。
- “趋势票池后做威科夫”可能已处中后段，需提供“全市场阶段扫描”作对照。
- 若目标是吸筹早期介入，优先关注A/B/C/D前段，不应仅追E段延续。

## 4.2 数据注意事项

- 必需字段：`code,date,open,high,low,close`，建议至少有`volume/amount`。
- 统一复权口径（前复权/后复权）后再计算事件。
- 停牌、涨跌停、异常成交量、错误日期必须在数据预处理阶段处理。
- TDX分钟数据可支持细化分析，但分钟级阈值不可直接照搬日线参数。
- 如果分钟与日线共用系统，必须明确“分析级别”并隔离参数模板。

## 4.3 回测注意事项

- 默认A股`T+1`生效：入场当日不可卖出。
- 交易成本需分开建模：单边手续费、印花税、滑点（可选）。
- `最大并发持仓`过小会导致大量信号被跳过，需提示填充率与跳过原因。
- 胜率低不等于策略差，应联合查看盈亏比、回撤、收益曲线稳定性。
- `Max DD`（最大回撤）必须清晰说明：权益从历史峰值到后续谷值的最大跌幅。
- MTM曲线和Realized曲线应同时展示，避免只看账面收益。

## 4.4 UI注意事项

- 模块必须分层清晰：数据、筛选、阶段池、回测、复盘。
- “主筛选”和“独立威科夫策略”必须明确是并列关系，不是强依赖关系。
- 参数文字避免歧义（如MA周期与斜率回看窗口需明确拆分）。
- 事件名、字段名、表头建议中英双语。
- 错误信息需可定位，包含字段名、模块名、修复建议。

---

## 5. 功能需求（PRD）

## 5.1 数据输入模块

- 支持T DX本地日线读取。
- 支持CSV单文件（多股票）与CSV文件夹（每股一文件）。
- 支持手动路径和自动路径发现。
- 支持编码自动识别与手动指定。
- 支持列名映射与元数据合并（股票名、行业、板块、市值等）。

## 5.2 威科夫特征与事件引擎

- 计算结构特征：`hh, hl, hc, lh, ll, lc`。
- 计算区间结构：`tr_high/tr_low/tr_width/tr_pos`。
- 识别吸筹链路事件：PS、SC、AR、ST、TSO、Spring、SOS、JOC、LPS。
- 识别派发链路事件：UTAD、SOW、LPSY。
- 生成事件命中字符串、事件计数、序列完整度标记。

## 5.3 阶段识别模块

- 输出阶段标签（吸筹A/B/C/D/E、派发A/B/C/D/E、阶段未明）。
- 输出阶段提示语（中文解释+交易注意）。
- 支持阶段池筛选（多选）。
- 支持“阶段+事件叠加过滤”。

## 5.4 筛选模块（策略层）

- 模式A：全市场威科夫扫描。
- 模式B：趋势池后置威科夫筛选。
- 模式C：用户自定义股票池威科夫筛选。
- 三种模式输出字段一致，便于比较。

## 5.5 回测模块（独立策略）

- 可配置入场事件组、离场事件组。
- 可配置止损、止盈、最大持仓K线、冷却K线。
- 可配置交易成本（单边bps）。
- 可配置仓位模型（固定、风险、最小）。
- 可配置同日优先级排序（优中选优）。
- 可配置优先模式：阶段优先、均衡、动量优先。
- 可配置同日TopK限流。
- 默认A股T+1约束。

## 5.6 报告导出模块

- 导出交易明细CSV。
- 导出完整ZIP报告，至少包含：
- `trades.csv`
- `equity_curve.csv`
- `metrics.json`
- `backtest_params.json`
- `sidebar_settings_snapshot.json`
- `notes.txt`
- `README.md`

## 5.7 可视化模块

- K线图叠加威科夫事件标记。
- 显示阶段、结构、关键信号摘要。
- 支持点数图（P&F）切换视图（新项目建议MVP后加入）。

---

## 6. 使用说明（面向终端用户）

## 6.1 标准工作流

1. 导入行情数据并完成字段映射。  
2. 选择分析模式（全市场/趋势池/自定义池）。  
3. 设置威科夫阶段和事件条件。  
4. 运行筛选，生成阶段股票池。  
5. 查看单股图表，确认阶段与结构一致性。  
6. 开启回测，设置仓位、成本、T+1、优中选优参数。  
7. 分析指标和交易明细。  
8. 导出完整报告用于复盘与参数迭代。  

## 6.2 回测参数解释（重点）

- `单边交易成本(bps)`：每次买或卖各收一次成本；10 bps=0.10%。
- `最大持仓K线`：单笔交易允许持有的最长K线数量，超出后按规则离场。
- `冷却K线`：某股票一笔交易结束后，需等待N根K线才能再次入场。
- `最大并发持仓`：同一时刻最多持有的股票数量上限。
- `同日候选TopK`：同一交易日仅保留评分前K名信号，0表示不限制。
- `T+1约束`：入场当天禁止卖出，符合A股规则。

## 6.3 回测指标解释（重点）

- `Win Rate`：盈利交易占比。
- `Avg Trade`：每笔平均收益率。
- `Cum Return`：累计收益率。
- `Max DD`：最大回撤，越小越稳健。
- `Fill Rate`：成交笔数/候选信号笔数。
- `Skipped/MaxPos`：被组合约束跳过的信号数/最大并发持仓。

## 6.4 关于“组合约束跳过信号”

该提示表示系统检测到入场信号，但因组合规则未执行，常见原因：

- 达到最大持仓上限。
- 可用现金不足。
- 价格异常无法成交。
- 风险仓位模式下止损参数不足导致无法计算仓位。

该指标是策略可执行性的关键，不应忽略。

---

## 7. 实现方法（技术方案）

## 7.1 建议模块架构

- `data_io`：TDX/CSV读取、清洗、字段标准化。
- `features`：均线、结构、波动、量能、区间特征。
- `wyckoff_events`：事件检测规则。
- `wyckoff_phase`：阶段判定与提示语。
- `screening`：阶段池构建、策略筛选。
- `backtest`：候选生成、优中选优、组合执行、绩效统计。
- `reporting`：表格格式化、导出。
- `ui`：参数输入、图表展示、交互逻辑。

## 7.2 事件检测实现建议

- 用滚动窗口构建交易区间（建议60日为默认）。
- 对事件规则使用“量价+位置+结构”联合条件。
- 各事件阈值必须参数化，不能硬编码死值。
- 保留事件命中明细，便于审计和解释。

## 7.3 阶段识别实现建议

- 优先使用事件驱动，再用结构与区间位置补全。
- 阶段映射需可维护，建议配置化。
- 阶段输出要有“置信线索”，例如：事件命中、结构分、区间位置。

## 7.4 优中选优实现建议

- 基础评分项：
- 事件强度分（按事件类型赋权）
- 阶段分（按介入性价比赋权）
- 结构分（HH/HL/HC）
- 趋势分（如20日收益）
- 波动修正分（过高波动降权）

- 优先模式建议：
- 阶段优先：适合找吸筹与突破前段。
- 均衡：适合通用扫描。
- 动量优先：适合强势延续。

- 执行顺序建议：
- 先按交易日分组
- 日内按评分排序
- 应用TopK限流
- 再进入资金与仓位约束执行

## 7.5 回测执行引擎建议

- 候选交易层：按信号生成“理论交易”。
- 组合执行层：考虑资金、仓位、并发约束后得到“实际交易”。
- 逐bar盯市层：输出MTM权益曲线与已实现权益曲线。
- 结果解释层：输出跳过原因统计和策略注释。

## 7.6 点数图（P&F）实现建议

- 作为图表层的可选视图，不影响核心回测逻辑。
- 参数包括：`box_size`、`reversal_boxes`、价格缩放规则。
- 先实现日线P&F，再扩展分钟级别。
- 在图上叠加阶段与事件标识，保持与K线视图一致语义。

---

## 8. 数据需求与接口规范

## 8.1 输入字段规范（最低）

- `code`：证券代码
- `date`：交易日期
- `open/high/low/close`：OHLC
- `volume`或`amount`：量能字段至少一个

## 8.2 推荐补充字段

- `name`、`market`、`board`、`industry`
- `float_mv`、`list_date`、`is_st`

## 8.3 输出字段规范（筛选）

- `wyckoff_phase`
- `wyckoff_signal`
- `structure_hhh`
- `wy_event_count`
- `wy_sequence_ok`
- `entry_quality_score`（如用于候选排序）

## 8.4 输出字段规范（回测交易）

- 信号日期、入场日期、离场日期
- 入场信号、阶段、阶段分、结构分、趋势分、波动分
- 入场价、离场价、持有K线数
- 离场原因
- 股数、开平仓金额、盈亏金额、收益率

---

## 9. 历史问题与重构对应方案（必须覆盖）

## 9.1 已暴露问题

- 选项状态不兼容导致`is not in iterable`异常。
- 序列比较索引不对齐导致`identically-labeled Series`异常。
- UI层级不清，用户误以为新旧策略必须串行强绑定。
- 参数标签描述不一致（MA周期与斜率窗口混淆）。
- 回测出现T+0记录，不符合A股规则。
- 表头术语英文过多，不利于读懂回测细节。
- 只导出交易列表，不导出参数和配置快照。
- 买点太多但仓位有限，策略执行可行性不足。

## 9.2 重构改进要求

- 强制模块解耦，避免误导执行关系。
- 状态清洗与兼容映射纳入系统初始化。
- 回测执行严格区分“候选信号”与“实际成交”。
- 引入优中选优与TopK限流机制。
- 所有核心指标与术语提供中英解释。
- 完整报告必须可复现回测结果。

---

## 10. 质量保障与测试要求

## 10.1 单元测试

- 事件识别函数测试（边界与缺失值）。
- 阶段分类测试（典型样本断言）。
- T+1约束测试（当日禁止卖出）。
- TopK与优先模式测试（排序与截断正确）。

## 10.2 回归测试

- 固定样本与固定参数下，交易笔数与关键指标应稳定。
- 导出报告字段结构与命名应稳定。
- UI参数变更不应影响未关联模块结果。

## 10.3 数据健康检查

- 日期递增与重复检查。
- OHLC合法性检查（high>=max(open,close)、low<=min(open,close)）。
- 量价异常值告警。

---

## 11. 版本规划建议

## v1（MVP）

- 日线威科夫事件识别
- 阶段池扫描
- 独立回测（T+1、成本、仓位、优中选优、TopK）
- 完整报告导出

## v2

- 点数图视图
- 分钟级（1m/5m）多周期确认
- 参数模板与批量回测

## v3

- 因子对比与组合优化
- 自动化复盘与策略监控

---

## 12. 威科夫事件中英说明（完整）

- `PS`：Preliminary Support，初步支撑
- `SC`：Selling Climax，卖出高潮
- `AR`：Automatic Rally，自动反弹
- `ST`：Secondary Test，二次测试
- `TSO`：Terminal Shakeout，终极震仓
- `Spring`：弹簧/假跌破
- `SOS`：Sign of Strength，强势信号
- `JOC`：Jump Over Creek，跃过小溪
- `LPS`：Last Point of Support，最后支撑点
- `UTAD`：Upthrust After Distribution，派发后假突破
- `SOW`：Sign of Weakness，弱势信号
- `LPSY`：Last Point of Supply，最后供应点

---

## 13. 八步标准序列说明（吸筹侧）

标准序列：

`PS -> SC -> AR -> ST -> Spring -> SOS -> JOC -> LPS`

解释要点：

- 序列完整是“结构成熟度”证据，不是“必须逐项严格出现”的硬条件。
- 实盘中可允许部分缺项，但缺项越多，阶段置信度应越低。
- 系统中应提供“是否完整”与“已出现哪些步骤”两个字段。

---

## 14. 风险提示与实盘边界

- 回测收益不代表未来收益。
- 低胜率策略可通过高盈亏比盈利，但回撤控制是生存底线。
- 高并发约束或低资金规模会明显降低Fill Rate。
- 如果目标是可实操，优先优化“可成交性”而非仅优化理论收益。

---

## 15. 新项目落地建议（执行顺序）

1. 先定输入标准与数据质检。  
2. 独立实现事件与阶段引擎。  
3. 实现独立威科夫筛选页面。  
4. 接入回测引擎并强制T+1默认开启。  
5. 接入优中选优模式和TopK。  
6. 打通完整报告导出。  
7. 最后接入点数图与分钟级扩展。  

---

## 16. 交付验收标准（建议）

- 能在全市场输出按阶段分组的股票池。
- 能基于事件组合独立回测并输出完整交易清单。
- 能解释每一笔成交的入场信号、阶段和优先分来源。
- 能输出“跳过信号原因统计”。
- 回测默认符合A股T+1约束。
- 报告导出包含参数快照，可复现。
- UI术语清晰，中英混合一致。

---

## 17. 结论

新项目应以“威科夫阶段与事件”为中心组织能力，趋势仅作为可选辅助过滤器。  
核心竞争力不在“信号数量”，而在“阶段判断质量 + 执行可行性 + 复盘可解释性”三者统一。  

