# 趋势票选股系统 v1.0（可视化+一键运行）

## 目标
将通达信导出的CSV数据，按文档中的5层漏斗筛选，生成可视化结果，并支持双击EXE运行。

## 一键打包EXE
1. 打开 PowerShell，进入项目目录。
2. 运行：
```powershell
.\build_exe.ps1
```
3. 生成后双击运行：
`dist\TrendPicker.exe`

## 本地运行（开发模式）
```powershell
.\run.ps1
```

## 数据格式要求

### 行情CSV（必须）
至少包含以下字段（大小写/中文均可自动识别）：
- `日期/交易日期`、`开盘`、`最高`、`最低`、`收盘`
- `成交量`（建议）  
- `代码/股票代码`（必须，单文件多股票场景）

常见列名示例：
```
日期,开盘,最高,最低,收盘,成交量,成交额,代码,名称
```

### 元数据CSV（可选）
用于板块/上市天数/流通市值等过滤：
```
代码,名称,板块,上市天数,流通市值,行业,板块5日涨幅
```
说明：
- `流通市值`默认按“元”处理，可在界面调整单位。
- 如果缺少相关字段，系统会自动跳过对应过滤，并给出提示。

### CSV 文件夹模式说明
- 填写路径和代码正则后，点击“读取CSV文件夹”才会真正加载数据。
- 代码正则无效、路径不存在或不是文件夹时，会显示错误提示。
- 文件名无法提取代码且CSV本身也没有代码列时，该文件会被自动跳过。

## 通达信 TDX 本地数据（自动读取）
如果你不想导出 CSV，可在界面选择“通达信本地数据（自动查找）”，程序会尝试定位 `vipdoc` 目录并直接读取 `.day` 日线数据。
常见路径示例：
```
C:\TdxW_HS\vipdoc
C:\Program Files (x86)\通达信\TdxW_HS\vipdoc
```
注意：本地数据通常缺少流通市值、上市天数等字段，对应过滤会自动跳过。

## 威科夫结构辅助（新增）
- 在筛选结果中新增 `结构(HH/HL/HC)`、`上升结构分(0-3)`、`威科夫阶段`、`关键事件` 字段。
- `关键事件` 已支持识别 `PS/SC/AR/ST/TSO` 以及 `Spring/SOS/JOC/LPS/UTAD` 等信号。
- 可在参数区启用“威科夫事件筛选”，支持“必须包含事件”与“标准8步序列完整（PS→SC→AR→ST→Spring→SOS→JOC→LPS）”过滤。
- `个股走势` 区域会显示当前股票的威科夫阶段、关键事件（如 `Spring/SOS/UTAD`）和阶段提示。
- 建议先完成策略筛选，再结合阶段与事件做图表复核。

## 威科夫事件回测（独立模块）
- 回测模块独立于分层筛选结果，只复用数据和可选股票池，不会反向改写筛选结果。
- 支持两种回测区间模式：
  - `按最近K线数`：按每只股票最近 N 根 K 线回测（原有逻辑）。
  - `自定义日期区间`：按开始/结束日期过滤样本区间回测。
- 区间说明：
  - 选择 `按最近K线数` 时，仅使用“回测K线数(每股)”。
  - 选择 `自定义日期区间` 时，仅使用“回测开始日期/回测结束日期”。
- 回测报告支持下载交易明细 CSV 和完整 ZIP（含权益曲线、指标、参数快照）。

## 目录结构
```
app/
  streamlit_app.py   # 可视化主程序
  run_app.py         # EXE启动入口
build_exe.ps1        # 打包脚本
run.ps1              # 本地运行脚本
requirements.txt
```

## 常见问题
- 若行情CSV没有“代码”列：请在导出时包含代码列，或使用“文件夹（每股一文件）”模式并通过文件名提取代码。
- EXE无法启动或白屏：请先用 `run.ps1` 验证能正常打开，再执行 `build_exe.ps1` 重新打包。
- 回测区间怎么设置：在“威科夫事件回测”中先选“回测区间模式”，再填写对应参数（K线数或开始/结束日期）。
